import streamlit as st
import pandas as pd
import datetime
import os

st.set_page_config(page_title="SWARA Anketi", layout="centered")

st.title("ğŸ“‹ SWARA Temelli Kriter Ã–nceliklendirme Anketi")

# --- Kriter Listesi ---
kriterler = [
    "Temizlik",
    "Ä°yi Ä°letiÅŸim ve Bilgilendirme",
    "Uygun FiyatlandÄ±rma",
    "Randevu KolaylÄ±ÄŸÄ±",
    "Sorunun Ã‡Ã¶zÃ¼me UlaÅŸtÄ±rÄ±lmasÄ±",
    "MÃ¼ÅŸteriye YÃ¶nelik Ã–zenli ve Ä°lgili Hizmet",
    "Ä°kame AraÃ§ Temini",
    "HÄ±zlÄ± Servis SÃ¼resi",
    "Uzman Personel",
    "Hizmet Kalitesi ve Teknik Ä°ÅŸÃ§ilik",
    "Yedek ParÃ§alarÄ±n HÄ±zlÄ± Temini",
    "GÃ¼venlik",
    "Temiz ve DÃ¼zenli Servis AlanÄ±",
    "Garanti ve Servis SonrasÄ± Destek"
]

st.header("1. Kriterleri Ã–ncelik SÄ±rasÄ±na GÃ¶re SeÃ§iniz")
st.markdown("14 kriteri sÄ±rayla seÃ§iniz. Her seÃ§im yapÄ±ldÄ±ÄŸÄ±nda, kriter alt listeye eklenir. TÃ¼m kriterler tamamlandÄ±ÄŸÄ±nda ikinci aÅŸamaya geÃ§ilir.")

if "secilenler" not in st.session_state:
    st.session_state.secilenler = []

secilmemisler = [k for k in kriterler if k not in st.session_state.secilenler]

st.subheader("SeÃ§ilebilir Kriterler:")
cols = st.columns(2)
for i, k in enumerate(secilmemisler):
    with cols[i % 2]:
        if st.button(k, key=f"buton_{k}"):
            if k not in st.session_state.secilenler:
                st.session_state.secilenler.append(k)

st.subheader("SeÃ§ilen SÄ±ralama:")
st.write(st.session_state.secilenler)

if len(st.session_state.secilenler) < 14:
    st.warning(f"SÄ±ralama tamamlanmadÄ±. LÃ¼tfen {14 - len(st.session_state.secilenler)} kriter daha seÃ§iniz.")
    st.stop()

ranked = st.session_state.secilenler

st.success("TÃ¼m kriterler sÄ±ralandÄ±!")
st.dataframe(pd.DataFrame({"SÄ±ra": list(range(1, 15)), "Kriter": ranked}))

# --- KarÅŸÄ±laÅŸtÄ±rmalar ---
st.header("2. KarÅŸÄ±laÅŸtÄ±rmalÄ± Ã–nem DeÄŸerlendirmesi")
st.markdown("Her bir Ã¼st sÄ±radaki kriterin alt sÄ±radakine gÃ¶re ne kadar daha Ã¶nemli olduÄŸunu seÃ§iniz.")

scale_labels = {
    1: "EÅŸit Ã–nemde",
    2: "Biraz Daha Ã–nemli",
    3: "Ã–nemli",
    4: "Ã‡ok Daha Ã–nemli",
    5: "AÅŸÄ±rÄ± Derecede Ã–nemli"
}

comparisons = []
for i in range(13):
    label = f"{ranked[i]} â†’ {ranked[i+1]}"
    value = st.slider(label, 1, 5, 3, format="%d")
    comparisons.append({"Ãœst Kriter": ranked[i], "Alt Kriter": ranked[i+1], "Ã–nem Derecesi": value, "AÃ§Ä±klama": scale_labels[value]})

comp_df = pd.DataFrame(comparisons)
st.dataframe(comp_df)

# --- TÃ¼m kullanÄ±cÄ± verilerini ortak bir Excel dosyasÄ±na kaydet ---
if st.button("GÃ¶nder ve Kaydet"):
    timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    comp_df.insert(0, "Zaman", timestamp)
    excel_path = "tum_swara_sonuclari.xlsx"

    try:
        if os.path.exists(excel_path):
            existing_df = pd.read_excel(excel_path)
            combined_df = pd.concat([existing_df, comp_df], ignore_index=True)
        else:
            combined_df = comp_df

        combined_df.to_excel(excel_path, index=False)
        st.success("Veriler baÅŸarÄ±yla kaydedildi. YÃ¶neticilere Ã¶zel olarak kayÄ±t altÄ±nda tutuluyor.")
    except Exception as e:
        st.error(f"Veri kaydedilirken bir hata oluÅŸtu: {e}")

st.info("Bu anket sonuÃ§larÄ± yalnÄ±zca yÃ¶neticinin eriÅŸebileceÄŸi bir Excel dosyasÄ±na kaydedilmektedir.")
